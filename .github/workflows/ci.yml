name: ci
on:
  pull_request:
  release:
    types: [published]
  push:
    tags: '*'
    branches:
      - main
      - develop

env:
  VERBOSE: 1


jobs:
  build-and-test:
    name: ${{matrix.os}} ${{matrix.compiler}} ${{matrix.cmake_build_type}}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false

      matrix:
        os: [macos-13, ubuntu-latest, windows-latest]
        cmake_build_type:
          - Release
          - Debug
        compiler:
          - Default tools

        exclude:
          - os: ubuntu-latest
            compiler: Default tools

        include:
          - os: ubuntu-latest
            compiler: clang

          - os: ubuntu-latest
            compiler: gcc

    steps:
      - name: Check for clang/clang-tidy version mismatches
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          clang_version=$(clang --version | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          clang_tidy_version=$(clang-tidy --version | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          if [ "$clang_version" != "$clang_tidy_version" ]; then
            echo "clang version $clang_version doesn't match clang-tidy version $clang_tidy_version"
            exit 1
          fi

      - name: Set up MSVC (Windows)
        uses: compnerd/gha-setup-vsdevenv@main

      - name: Set up latest CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          show-progress: false

      - name: Configure
        run: |
          cmake -Wno-dev -S . -B ./build -GNinja  -DCMAKE_BUILD_TYPE:STRING=${{matrix.cmake_build_type}} -DCMAKE_CXX_STANDARD=17

      - name: Build
        run: |
          cmake --build ./build

      - name: Test
        run: |
          ctest --test-dir ./build

